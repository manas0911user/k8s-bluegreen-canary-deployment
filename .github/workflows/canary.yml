name: Auto-Canary-Pipeline (FREE)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  canary:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Create local Kubernetes cluster (FREE)
      - name: Setup KIND cluster
        uses: helm/kind-action@v1

      # 3Ô∏è‚É£ Build Docker images
      - name: Build Images
        run: |
          docker build -t blue-nginx:1 ./nginx-html
          docker build -t green-nginx:1 ./nginx-html

      # 4Ô∏è‚É£ Load images into cluster
      - name: Load Images into KIND
        run: |
          kind get clusters
          kubectl cluster-info
          kind load docker-image blue-nginx:1 --name kind
          kind load docker-image green-nginx:1 --name kind

      # 5Ô∏è‚É£ Deploy BLUE (stable)
      - name: Deploy Blue Version
        run: |
          kubectl apply -f kubernetes/service.yaml
          kubectl apply -f kubernetes/blue-deploy.yaml

      # 6Ô∏è‚É£ Deploy GREEN Canary
      - name: Deploy Green Canary (20%)
        run: |
          kubectl apply -f kubernetes/green-deploy.yaml

      # 7Ô∏è‚É£ Simulated Health Check
      - name: Canary Health Check
        run: |
          echo "üîç Checking Canary Pods..."
          kubectl get pods

      # 8Ô∏è‚É£ AUTO PROMOTE Canary ‚Üí Stable
      - name: Promote Canary
        run: |
          echo "üöÄ Promoting Green to Stable..."
          kubectl delete -f kubernetes/blue-deploy.yaml